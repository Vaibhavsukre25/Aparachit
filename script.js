// Garuda Purana Punishment Database System
// All complaints and punishments stored locally

const punishmentDatabase = {
    "‡§ï‡•ç‡§∞‡•ã‡§ß": {
        name: "‡§ï‡•ç‡§∞‡•ã‡§ß - ‡§ï‡•ç‡§∞‡•Ç‡§∞‡§§‡§æ ‡§ï‡§æ ‡§¶‡§Ç‡§°",
        punishments: [
            "‡§§‡§Æ‡•ç‡§∏‡§∞‡§æ‡§ú ‡§®‡§∞‡§ï ‡§Æ‡•á‡§Ç: ‡§≠‡•Ä‡§∑‡§£ ‡§Ü‡§ó ‡§∏‡•á ‡§∏‡§°‡§æ ‡§¶‡§ø‡§Ø‡§æ ‡§ú‡§æ‡§è‡§ó‡§æ",
            "‡§∂‡§∞‡•Ä‡§∞ ‡§™‡§∞ ‡§§‡§™‡§§‡•á ‡§≤‡•ã‡§π‡•á ‡§ï‡•Ä ‡§õ‡§°‡§º‡•á‡§Ç: ‡§π‡§ú‡§æ‡§∞ ‡§ó‡•Å‡§®‡§æ ‡§™‡•Ä‡§°‡§º‡§æ"
        ],
        severity: 9
    },
    "‡§≤‡•ã‡§≠": {
        name: "‡§≤‡•ã‡§≠ - ‡§≤‡§æ‡§≤‡§ö ‡§ï‡§æ ‡§¶‡§Ç‡§°",
        punishments: [
            "‡§§‡§∞‡§≤‡•å‡§π: ‡§™‡§ø‡§ò‡§≤‡•Ä ‡§π‡•Å‡§à ‡§ß‡§æ‡§§‡•Å ‡§®‡§ø‡§ó‡§≤‡§®‡•Ä ‡§π‡•ã‡§ó‡•Ä ‡§∏‡§¶‡§æ",
            "‡§¶‡§∞‡§ø‡§¶‡•ç‡§∞‡§§‡§æ ‡§ï‡§æ ‡§ö‡§ï‡•ç‡§∞: ‡§π‡§Æ‡•á‡§∂‡§æ ‡§≠‡•Ç‡§ñ‡•á-‡§®‡§Ç‡§ó‡•á ‡§∞‡§π‡§®‡§æ"
        ],
        severity: 8
    },
    "‡§ï‡§æ‡§Æ": {
        name: "‡§ï‡§æ‡§Æ - ‡§µ‡§æ‡§∏‡§®‡§æ ‡§ï‡§æ ‡§¶‡§Ç‡§°",
        punishments: [
            "‡§µ‡§ó ‡§®‡§∞‡§ï ‡§Æ‡•á‡§Ç ‡§≠‡§∏‡•ç‡§Æ ‡§π‡•ã‡§®‡§æ: ‡§∂‡§∞‡•Ä‡§∞ ‡§™‡§∞ ‡§§‡•Ä‡§ï‡•ç‡§∑‡•ç‡§£ ‡§Ö‡§ó‡•ç‡§®‡§ø",
            "‡§ï‡§æ‡§Æ ‡§ï‡•Ä ‡§≠‡•Ä‡§∑‡§£ ‡§™‡•Ä‡§°‡§º‡§æ: ‡§∂‡§∞‡•Ä‡§∞ ‡§ï‡•á ‡§π‡§∞ ‡§Ö‡§Ç‡§ó ‡§Æ‡•á‡§Ç ‡§¶‡§∞‡•ç‡§¶"
        ],
        severity: 8
    },
    "‡§Ö‡§π‡§Ç‡§ï‡§æ‡§∞": {
        name: "‡§Ö‡§π‡§Ç‡§ï‡§æ‡§∞ - ‡§ò‡§Æ‡§Ç‡§° ‡§ï‡§æ ‡§¶‡§Ç‡§°",
        punishments: [
            "‡§µ‡§ø‡§ú‡•Å ‡§®‡§∞‡§ï ‡§Æ‡•á‡§Ç: ‡§ï‡•Ä‡§°‡§º‡•á ‡§¨‡§®‡§ï‡§∞ ‡§∏‡§°‡§®‡§æ",
            "‡§Ö‡§™‡§Æ‡§æ‡§® ‡§î‡§∞ ‡§§‡§ø‡§∞‡§∏‡•ç‡§ï‡§æ‡§∞ ‡§∏‡§¶‡§æ: ‡§∏‡§Æ‡§æ‡§ú ‡§∏‡•á ‡§®‡§ø‡§∑‡•ç‡§ï‡§æ‡§∏‡§®"
        ],
        severity: 7
    },
    "‡§Æ‡§π‡§ú": {
        name: "‡§Æ‡§π‡§ú - ‡§à‡§∞‡•ç‡§∑‡•ç‡§Ø‡§æ ‡§ï‡§æ ‡§¶‡§Ç‡§°",
        punishments: [
            "‡§ï‡§®‡•ç‡§•‡§∞ ‡§®‡§∞‡§ï ‡§Æ‡•á‡§Ç: ‡§¶‡•Ç‡§∏‡§∞‡•ã‡§Ç ‡§ï‡•Ä ‡§ñ‡•Å‡§∂‡•Ä ‡§¶‡•á‡§ñ‡§§‡•á ‡§∞‡§π‡§®‡§æ ‡§≤‡•á‡§ï‡§ø‡§® ‡§™‡•Ä‡§°‡§º‡§æ ‡§∏‡§π‡§®‡§æ",
            "‡§µ‡•á‡§¶‡§®‡§æ ‡§ï‡§æ ‡§∏‡§´‡§∞: ‡§π‡§Æ‡•á‡§∂‡§æ ‡§Ö‡§∏‡§Ç‡§§‡•Å‡§∑‡•ç‡§ü ‡§∞‡§π‡§®‡§æ"
        ],
        severity: 7
    },
    "‡§Ü‡§≤‡§∏‡•ç‡§Ø": {
        name: "‡§Ü‡§≤‡§∏‡•ç‡§Ø - ‡§∏‡•Å‡§∏‡•ç‡§§‡•Ä ‡§ï‡§æ ‡§¶‡§Ç‡§°",
        punishments: [
            "‡§Ö‡§Ç‡§ß‡§ï‡§æ‡§∞ ‡§®‡§∞‡§ï ‡§Æ‡•á‡§Ç: ‡§®‡§ø‡§∞‡§Ç‡§§‡§∞ ‡§Ö‡§Ç‡§ß‡•á‡§∞‡•á ‡§Æ‡•á‡§Ç ‡§≠‡§ü‡§ï‡§®‡§æ",
            "‡§∂‡§ï‡•ç‡§§‡§ø‡§π‡•Ä‡§®‡§§‡§æ: ‡§ï‡•ã‡§à ‡§ï‡§æ‡§Æ ‡§ï‡§∞‡§®‡•á ‡§ï‡•Ä ‡§ï‡•ç‡§∑‡§Æ‡§§‡§æ ‡§® ‡§π‡•ã‡§®‡§æ"
        ],
        severity: 6
    },
    "‡§õ‡§≤": {
        name: "‡§õ‡§≤ - ‡§ß‡•ã‡§ñ‡•á ‡§ï‡§æ ‡§¶‡§Ç‡§°",
        punishments: [
            "‡§®‡§ø‡§ï‡•Å‡§Æ‡•ç‡§≠‡§ø‡§≤ ‡§®‡§∞‡§ï: ‡§π‡§∞ ‡§∏‡§Æ‡§Ø ‡§ß‡•ã‡§ñ‡§æ ‡§ñ‡§æ‡§®‡§æ ‡§î‡§∞ ‡§™‡§õ‡§§‡§æ‡§®‡§æ",
            "‡§µ‡§ø‡§∂‡•ç‡§µ‡§æ‡§∏ ‡§ü‡•Ç‡§ü‡§®‡§æ: ‡§ï‡•ã‡§à ‡§Ü‡§™‡§ï‡•ã ‡§µ‡§ø‡§∂‡•ç‡§µ‡§æ‡§∏ ‡§® ‡§ï‡§∞‡•á"
        ],
        severity: 8
    },
    "‡§Ö‡§ß‡§∞‡•ç‡§Æ": {
        name: "‡§Ö‡§ß‡§∞‡•ç‡§Æ - ‡§∏‡§∞‡•ç‡§µ‡•ã‡§ö‡•ç‡§ö ‡§™‡§æ‡§™ ‡§ï‡§æ ‡§¶‡§Ç‡§°",
        punishments: [
            "‡§Æ‡§π‡§æ‡§∞‡•å‡§∞‡§µ ‡§®‡§∞‡§ï ‡§Æ‡•á‡§Ç: ‡§Ø‡§Æ‡§¶‡•Ç‡§§ ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§Ö‡§®‡§Ç‡§§ ‡§™‡•ç‡§∞‡§§‡§æ‡§°‡§º‡§®‡§æ",
            "‡§∏‡§≠‡•Ä ‡§®‡§∞‡§ï‡•ã‡§Ç ‡§ï‡§æ ‡§∏‡§Ç‡§ö‡§Ø: ‡§∏‡§≠‡•Ä ‡§¶‡§Ç‡§° ‡§è‡§ï ‡§∏‡§æ‡§• ‡§≠‡•Å‡§ó‡§§‡§®‡§æ ‡§™‡§°‡§º‡•á‡§ó‡§æ"
        ],
        severity: 10
    }
};

// Advanced Complaint Database Class
class ComplaintDatabase {
    constructor() {
        this.storageKey = 'aparichitComplaints';
        this.analyticsKey = 'aparichitAnalytics';
    }

    addComplaint(complaintData) {
        const complaints = this.getAllComplaints();
        const newComplaint = {
            id: Date.now(),
            timestamp: new Date().toLocaleString('en-IN'),
            status: 'PENDING',
            ipInfo: this.getDeviceInfo(),
            // include provided fields (text, category, severity, punishment, reporterName, etc.)
            ...complaintData
        };
        complaints.push(newComplaint);
        localStorage.setItem(this.storageKey, JSON.stringify(complaints));
        this.updateAnalytics(complaintData.category);
        return newComplaint;
    }

    getAllComplaints() {
        const data = localStorage.getItem(this.storageKey);
        return data ? JSON.parse(data) : [];
    }

    getComplaintsByCategory(category) {
        return this.getAllComplaints().filter(c => c.category === category);
    }

    getComplaintSeverityStats() {
        const complaints = this.getAllComplaints();
        return complaints.reduce((acc, c) => ({
            ...acc,
            [c.category]: (acc[c.category] || 0) + 1
        }), {});
    }

    updateAnalytics(category) {
        const analytics = this.getAnalytics();
        if (!analytics[category]) {
            analytics[category] = 0;
        }
        analytics[category]++;
        localStorage.setItem(this.analyticsKey, JSON.stringify(analytics));
    }

    getAnalytics() {
        const data = localStorage.getItem(this.analyticsKey);
        return data ? JSON.parse(data) : {};
    }

    deleteComplaint(id) {
        let complaints = this.getAllComplaints();
        complaints = complaints.filter(c => c.id !== id);
        localStorage.setItem(this.storageKey, JSON.stringify(complaints));
    }

    exportComplaints() {
        return this.getAllComplaints();
    }

    getDeviceInfo() {
        return {
            userAgent: navigator.userAgent,
            language: navigator.language,
            timestamp: new Date().toISOString()
        };
    }

    clearAllComplaints() {
        if (confirm('Are you sure you want to delete all complaints? This action cannot be undone!')) {
            localStorage.removeItem(this.storageKey);
            return true;
        }
        return false;
    }
}

// Initialize Database
const db = new ComplaintDatabase();
// API base (server). Adjust or set window.API_BASE if different (e.g., production)
const API_BASE = window.API_BASE || 'http://localhost:4000';

// Utility: read attachment(s) as data URLs (returns Promise)
function readAttachments(fileInput) {
    return new Promise((resolve) => {
        const files = fileInput && fileInput.files ? Array.from(fileInput.files) : [];
        if (!files.length) return resolve([]);
        const readers = files.map(f => {
            return new Promise((res) => {
                const r = new FileReader();
                r.onload = () => res({ name: f.name, type: f.type, data: r.result });
                r.onerror = () => res(null);
                r.readAsDataURL(f);
            });
        });
        Promise.all(readers).then(results => resolve(results.filter(Boolean)));
    });
}

// Enable site audio after user gesture
function enableAudio() {
    localStorage.setItem('aparichitAudioEnabled', '1');
    const vids = document.querySelectorAll('video');
    const auds = document.querySelectorAll('audio');
    vids.forEach(v => { try { v.muted = false; v.play().catch(()=>{}); } catch(e){} });
    auds.forEach(a => { try { a.muted = false; a.play().catch(()=>{}); } catch(e){} });
}

// Small helper for validating email
function isValidEmail(email) {
    return /\S+@\S+\.\S+/.test(email);
}

// Form Submission Handler (supports new fields & attachments)
document.addEventListener('DOMContentLoaded', function() {
    const input = document.getElementById("input");
    const btn = document.getElementById("submit");
    const categorySelect = document.getElementById("category");
    const punishmentPreview = document.getElementById("punishmentPreview");
    const attachments = document.getElementById('attachments');
    const reporterName = document.getElementById('reporterName');
    const reporterEmail = document.getElementById('reporterEmail');
    const targetName = document.getElementById('targetName');
    const identifier = document.getElementById('identifier');

    // Show preview when category changes
    if (categorySelect) {
        categorySelect.addEventListener('change', function() {
            const selectedCategory = this.value;
            const punishment = punishmentDatabase[selectedCategory];
            if (punishment && punishmentPreview) {
                punishmentPreview.innerHTML = `<strong>‡§¶‡§Ç‡§° ‡§ï‡•Ä ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä:</strong> ${punishment.name}<br><em>"${punishment.punishments[0]}"</em>`;
                punishmentPreview.classList.add('show');
            }
        });
    }

    if (btn) {
        btn.addEventListener("click", async function(e) {
            e.preventDefault();
            const complaintText = input ? input.value.trim() : '';
            const selectedCategory = categorySelect ? categorySelect.value : "‡§Ö‡§ß‡§∞‡•ç‡§Æ";
            const rName = reporterName ? reporterName.value.trim() : '';
            const rEmail = reporterEmail ? reporterEmail.value.trim() : '';
            const tName = targetName ? targetName.value.trim() : '';
            const iden = identifier ? identifier.value.trim() : '';

            if (!rName) { alert('‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ö‡§™‡§®‡§æ ‡§®‡§æ‡§Æ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç‡•§'); return; }
            if (!rEmail || !isValidEmail(rEmail)) { alert('‡§ï‡•É‡§™‡§Ø‡§æ ‡§µ‡•à‡§ß ‡§à‡§Æ‡•á‡§≤ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç‡•§'); return; }
            if (!tName) { alert('‡§ï‡•É‡§™‡§Ø‡§æ ‡§ú‡§ø‡§∏ ‡§µ‡•ç‡§Ø‡§ï‡•ç‡§§‡§ø/‡§∏‡§Ç‡§∏‡•ç‡§•‡§æ ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡§®‡§æ ‡§π‡•à ‡§µ‡§π ‡§≠‡§∞‡•á‡§Ç‡•§'); return; }
            if (!complaintText || complaintText.length < 10) { alert('‚ö† ‡§ï‡§Æ ‡§∏‡•á ‡§ï‡§Æ 10 ‡§∂‡§¨‡•ç‡§¶ ‡§≤‡§ø‡§ñ‡•ã!'); return; }

            const punishment = punishmentDatabase[selectedCategory] || punishmentDatabase["‡§Ö‡§ß‡§∞‡•ç‡§Æ"];
            const randomPunishment = punishment.punishments[Math.floor(Math.random() * punishment.punishments.length)];

            // read attachments (if any) with client-side limits (5MB each)
            const filesData = attachments ? await readAttachments(attachments) : [];
            for (const f of (attachments.files || [])) {
                if (f.size > 5 * 1024 * 1024) { alert('Each attachment must be <= 5MB'); return; }
            }

            const payload = {
                text: complaintText,
                category: selectedCategory,
                severity: punishment.severity,
                punishment: randomPunishment,
                reporterName: rName,
                reporterEmail: rEmail,
                targetName: tName,
                identifier: iden
            };

            // Try sending to server API first; fallback to localStorage if unavailable
            let savedComplaint = null;
            try {
                const form = new FormData();
                Object.keys(payload).forEach(k => form.append(k, payload[k]));
                if (attachments && attachments.files) {
                    Array.from(attachments.files).forEach(f => form.append('attachments', f, f.name));
                }
                const res = await fetch(`${API_BASE}/api/complaints`, { method: 'POST', body: form });
                if (res.ok) {
                    const data = await res.json();
                    savedComplaint = { id: data.id, ...payload };
                } else { throw new Error('server error'); }
            } catch (e) {
                // Fallback: save in localStorage as before
                const complaint = db.addComplaint({
                    text: complaintText,
                    category: selectedCategory,
                    severity: punishment.severity,
                    punishment: randomPunishment,
                    reporterName: rName,
                    reporterEmail: rEmail,
                    targetName: tName,
                    identifier: iden,
                    attachments: filesData
                });
                savedComplaint = complaint;
            }

            // Save to session for confirmation page
            sessionStorage.setItem('currentComplaint', JSON.stringify(savedComplaint));

            // Provide immediate feedback
            input.value = "";
            input.value = "üíÄ ‡§Ü‡§™‡§ï‡•Ä ‡§µ‡•á‡§¶‡§®‡§æ ‡§¶‡§∞‡•ç‡§ú ‡§π‡•ã ‡§ó‡§à! ‡§®‡§∞‡§ï ‡§ï‡•Ä ‡§∏‡§ú‡§æ ‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§π‡•à! üíÄ";
            input.style.color = "#ff0000";

            // Attempt to enable audio if user previously allowed
            if (localStorage.getItem('aparichitAudioEnabled')) enableAudio();

            setTimeout(() => {
                window.location.href = "Confirmation.html";
            }, 1200);
        });
    }
});

// Admin Dashboard Function
function viewAllComplaints() {
    const complaints = db.getAllComplaints();
    console.log('Total Complaints:', complaints.length);
    console.log('All Complaints:', complaints);
    return complaints;
}

function getComplaintStats() {
    const stats = db.getAnalytics();
    console.log('Complaint Statistics:', stats);
    return stats;
}

// Export for debugging
window.aparichitDB = db;
